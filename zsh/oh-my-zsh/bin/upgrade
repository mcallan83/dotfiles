#!/usr/bin/env bash

################################################################################
# Upgrades:
#   - Homebrew
#   - Homebrew Casks
#   - Vagrant plugins
#   - Composer (and global packages)
#   - NVM (and global NPM packages)
################################################################################

sudo -v

banner() {
    echo -e "\n\n\033[0;34m"
    printf "%0.s#" {1..80}
    echo -e "\n# Updating: ${1}"
    printf "%0.s#" {1..80}
    echo -e "$(tput sgr0)\n"
    return
}

if test $(which brew); then
    banner "Homebrew"
    brew analytics off
    brew update
    brew upgrade
    brew cask upgrade
    brew cleanup
    (cd "$(brew --repo)" && git prune && git gc)
    rm -rf "$(brew --cache)"
    brew doctor
    brew cask doctor
fi

if test $(which vagrant); then
    banner "Vagrant Plugins"
    vagrant plugin repair
    vagrant plugin update
fi

# composer
if test $(which composer); then
    banner "Composer"
    composer self-update
    composer global update
fi

# node
if [ -d "$NVM_DIR" ]; then
    banner "Node"
    (
      cd "$NVM_DIR"
      git fetch --tags origin
      git checkout `git describe --abbrev=0 --tags --match "v[0-9]*" $(git rev-list --tags --max-count=1)`
    ) && \. "$NVM_DIR/nvm.sh"
    nvm use default
    npm update -g
fi

# register update time
git config --global dotfiles.lastupdate "$(date +%Y%m%d%H%M)"
